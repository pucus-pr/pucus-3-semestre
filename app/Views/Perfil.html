<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Perfil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet">
  <link href="css/styleperf.css" rel="stylesheet">
  <link href="css/nav.css" rel="stylesheet">
  <link href="css/home.css" rel="stylesheet">
</head>

<body>
  <nav>
    <ul>
        <li class="logo">
            <img alt="Logo" src="img/polvo.png">
        </li>
        <li><a href="home"><i class="fa fa-home"></i> home</a></li>
        <li><a href="#"><i class="fa fa-book"></i> placeholder</a></li>
        <li><a href="#"><i class="fa fa-users"></i> placeholder</a></li>
        <li><a href="perfil"><i class="bi bi-person-lines-fill"></i> Perfil</a></li>
    </ul>
</nav>

  <div class="wrapper">
    <div class="profile">
      <!-- Banner -->
      <div class="cover-photo">
        <img id="banner-img" src="img/placeholder-banner.jpg" alt="">
      </div>

      <!-- Foto de perfil, nome, email, bio, curso -->
      <div class="profile-info">
        <img id="profile-img" src="img/placeholder-profile.jpg" alt="Foto de Perfil" class="profile-pic">
        <h2 id="profile-name"></h2>
        
        <p id="profile-email"></p>
        <p id="profile-bio"></p>
        <div class="info">
          <span id="profile-course"></span>
        </div>
        <button class="edit-profile-btn" onclick="openModal()">Editar perfil</button>
      </div>

      <div id="posts-container">
        

      </div>
        <!-- Os posts tem q estar aqui -->
      
    </div>
  </div>

  
  <div id="editProfileModal" class="edit-profile-modal">
    <div class="edit-profile-modal-content">
      <div class="edit-profile-modal-header">
        <h2>Editar Perfil</h2>
        <span class="edit-profile-close" onclick="closeModal()">&times;</span>
      </div>

      <div class="edit-profile-cover-photo">
        <img src="img/adamfoda.jpg" alt="Capa">
        <label class="edit-profile-upload-btn">
          <i class="bi bi-camera-fill"></i>
          <input type="file" id="coverPhotoInput">
        </label>
      </div>

      <div class="edit-profile-profile-photo">
        <img src="img/adan.png" alt="Perfil">
        <label class="edit-profile-upload-btn small">
          <i class="bi bi-camera-fill"></i>
          <input type="file" id="profilePhotoInput">
        </label>
      </div>

      <form  class="edit-profile-modal-body">
        <label for="username">Nome</label>
        <input type="text" id="username" placeholder="Digite seu nome">

        <label for="userhandle">@user</label>
        <input type="text" id="userhandle" placeholder="@exemplo">

        <label for="bio">Bio</label>
        <textarea id="bio" placeholder="Algo sobre você..."></textarea>

        <label for="course">Curso</label>
        <input type="text" id="course" placeholder="Seu curso">


        <button type="button" class="edit-profile-save-btn" onclick="saveProfile1()">Salvar</button>
      </form>
    </div>
  </div>

  <script>
    function openModal() {
      document.getElementById('editProfileModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('editProfileModal').style.display = 'none';
    }

    window.onclick = function (event) {
      const modal = document.getElementById('editProfileModal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    function saveProfile1() {
      const user = JSON.parse(localStorage.getItem("user")) || {};

      user.name = document.getElementById("username").value;
      user.email = document.getElementById("userhandle").value;
      user.bio = document.getElementById("bio").value;
      user.course = document.getElementById("course").value;

      localStorage.setItem("user", JSON.stringify(user));

      alert("Perfil salvo com sucesso!");
      location.reload(); // Recarrega para refletir as mudanças
}

  </script>

<script>
  // Mapeamento de tags para ícones (mantido igual)
  const tagIcons = {
    1: '<i class="bi bi-shield-fill-exclamation"></i>',
    2: '<i class="bi bi-pc-display-horizontal"></i>',
    3: '<i class="bi bi-stars"></i>',
    4: '<i class="bi bi-building-fill"></i>',
    5: '<i class="bi bi-exclamation-triangle-fill"></i>'
  };

  // Função para converter tags em ícones (mantido igual)
  function convertTagsToIcons(tags) {
    if (!tags || !Array.isArray(tags)) return '';
    
    return tags.map(tag => {
      const tagId = typeof tag === 'object' ? tag.id : tag;
      return tagIcons[tagId] || `<span>${tagId}</span>`;
    }).join('');
  }

  // Função para criar elementos de postagem - AJUSTADA PARA PÁGINA DE PERFIL
  function createPostElement(post) {
    const postElement = document.createElement('div');
    postElement.classList.add('post');
    postElement.dataset.postId = post.id

    // Formata a data
    const postDate = new Date(post.created_at);
    const formattedDate = `${postDate.getDate()}/${postDate.getMonth() + 1}/${postDate.getFullYear()}`;

    // Converte as tags em ícones
    const tags = post.tags || [];
    const tagsHtml = convertTagsToIcons(tags);
    
    const imageHtml = post.image ? 
      `<div class="postmid"><img src="${post.image.replace(/\\/g, '/').replace('C:/xampp/htdocs/pucus/app/Models/../../public/', '')}" alt="Imagem do Post"></div>` : 
      '';

    postElement.innerHTML = `
      <div class="postHeader">
        <div class="postIcon">
          <img src="${post.user_image || 'img/placeholder-profile.jpg'}" width="70px" alt="Foto de Perfil">
        </div>
        <div class="postNnD">
          <h1>${post.user_name || 'Usuário'}</h1>
          <p>${formattedDate}</p>
        </div>
        <button class="threeDotsBtn"><i class="bi bi-three-dots"></i></button>
          <div class="postActions" style="display:none;">
            <button class="editPostBtn">Editar</button>
            <button class="deletePostBtn">Apagar</button>
          </div>
      </div>
      <div class="postDescription">
        <p>${post.text || ''}</p>
      </div>
      ${imageHtml}
      <div class="postBot">
        <div class="upVolt"><i class="bi bi-arrow-up"></i></div>
        <div class="tags">${tagsHtml}</div>
        <div class="downVolt"><i class="bi bi-arrow-down"></i></div>
      </div>
    `;

    postElement.innerHTML += `
        <div class="editTagsModal" style="display:none;">
            <div class="editTagsContent">
                <h3>Editar Tags</h3>
                <div class="tagsCheckboxes">
                    <label><input type="checkbox" value="1"> <i class="bi bi-shield-fill-exclamation"></i> Tag 1</label>
                    <label><input type="checkbox" value="2"> <i class="bi bi-pc-display-horizontal"></i> Tag 2</label>
                    <label><input type="checkbox" value="3"> <i class="bi bi-stars"></i> Tag 3</label>
                    <label><input type="checkbox" value="4"> <i class="bi bi-building-fill"></i> Tag 4</label>
                    <label><input type="checkbox" value="5"> <i class="bi bi-exclamation-triangle-fill"></i> Tag 5</label>
                </div>
                <div class="editTagsActions">
                    <button class="cancelEditTags">Cancelar</button>
                    <button class="confirmEditTags">Confirmar</button>
                </div>
            </div>
        </div>
    `;

    // Adiciona funcionalidade de deletar post

    const threeDotsBtn = postElement.querySelector('.threeDotsBtn');
    const postActions = postElement.querySelector('.postActions');
    
    threeDotsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        // Alterna a visibilidade do menu de ações
        postActions.style.display = postActions.style.display === 'none' ? 'block' : 'none';
    });

    // Adiciona evento para deletar post
    const deletePostBtn = postElement.querySelector('.deletePostBtn');
    deletePostBtn.addEventListener('click', async () => {
        if(confirm('Tem certeza que deseja deletar este post?')) {
            try {
                const response = await fetch(`/api/posts/${post.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if(response.ok) {
                    postElement.remove();
                } else {
                    alert('Erro ao deletar post');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao deletar post');
            }
        }
    });

    // Fecha o menu de ações quando clicar fora
    document.addEventListener('click', (e) => {
        if(!postElement.contains(e.target)) {
            postActions.style.display = 'none';
        }
    });

    const editPostBtn = postElement.querySelector('.editPostBtn');
    editPostBtn.addEventListener('click', () => {
        const editModal = postElement.querySelector('.editTagsModal');
        const checkboxes = editModal.querySelectorAll('input[type="checkbox"]');
        
        // Marca as checkboxes baseado nas tags atuais do post
        checkboxes.forEach(checkbox => {
            checkbox.checked = post.tags && post.tags.some(tag => 
                (typeof tag === 'object' ? tag.id : tag) == checkbox.value
            );
        });
        
        editModal.style.display = 'block';
        postActions.style.display = 'none'; // Fecha o menu de ações
    });

    // Adiciona eventos para os botões do modal
    const cancelBtn = postElement.querySelector('.cancelEditTags');
    cancelBtn.addEventListener('click', () => {
        postElement.querySelector('.editTagsModal').style.display = 'none';
    });

    const confirmBtn = postElement.querySelector('.confirmEditTags');
confirmBtn.addEventListener('click', async () => {
    const selectedTags = [...postElement.querySelectorAll('.tagsCheckboxes input:checked')]
        .map(cb => parseInt(cb.value));
    
    try {
        const response = await fetch(`/api/updatePostTags/${post.id}`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json' // Garante que queremos JSON de volta
            },
            body: JSON.stringify({ tags: selectedTags })
        });

        // Verifica primeiro o tipo de conteúdo
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Resposta não é JSON: ${text.substring(0, 100)}...`);
        }

        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || 'Erro ao atualizar tags');
        }

        // Atualiza a visualização
        postElement.querySelector('.tags').innerHTML = convertTagsToIcons(selectedTags);
        postElement.querySelector('.editTagsModal').style.display = 'none';
        
        // Atualiza o post no array global se existir
        if (window.userPosts) {
            const postIndex = window.userPosts.findIndex(p => p.id === post.id);
            if (postIndex !== -1) {
                window.userPosts[postIndex].tags = selectedTags;
            }
        }
        
    } catch (error) {
        console.error('Erro ao atualizar tags:', error);
        alert(error.message || 'Erro ao atualizar tags');
    }
});

    // Fecha o modal quando clicar fora
    const editModal = postElement.querySelector('.editTagsModal');
    editModal.addEventListener('click', (e) => {
        if(e.target === editModal) {
            editModal.style.display = 'none';
        }
    });

    return postElement;
}

  






  // Carrega posts do usuário logado
  async function loadUserPosts() {
  try {
    // Recupera o usuário do localStorage
    const userString = localStorage.getItem('user');
    if (!userString) {
      throw new Error('Nenhum usuário encontrado no localStorage');
    }

    const user = JSON.parse(userString);
    
    if (!user || !user.id) {
      throw new Error('ID do usuário não encontrado');
    }

    const response = await fetch(`/api/get-posts-by-user-id`);
    
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Verifica e converte os posts para array
    let posts = [];
    if (Array.isArray(data)) {
      posts = data;
    } else if (data && typeof data === 'object') {
      // Tenta extrair posts de diferentes estruturas de resposta
      posts = data.posts || data.data || data.result || [];
    }
    
    const postsContainer = document.getElementById('posts-container');
    postsContainer.innerHTML = '';
    
    if (posts.length === 0) {
      postsContainer.innerHTML = '<div class="no-posts">Você ainda não fez nenhum post</div>';
    } else {
      // Ordena apenas se for array
      if (Array.isArray(posts)) {
        posts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      }
      
      posts.forEach(post => {
        postsContainer.appendChild(createPostElement(post));
      });
    }
    
  } catch (error) {
    console.error('Erro ao carregar posts:', error);
    document.getElementById('posts-container').innerHTML = `
      <div class="error-message">
        Ocorreu um erro ao carregar seus posts.<br>
        ${error.message}<br>
        <button onclick="location.reload()">Recarregar</button>
      </div>
    `;
  }
}
  // Carrega os dados quando a página é aberta
  document.addEventListener("DOMContentLoaded", () => {
  try {
    const userString = localStorage.getItem('user');
    if (!userString) {
      throw new Error('Por favor, faça login para acessar esta página');
    }

    const user = JSON.parse(userString);
    
    // Verifica se o objeto user tem as propriedades mínimas necessárias
    if (!user.id || !user.name) {
      throw new Error('Dados do usuário incompletos');
    }

    // Preenche os dados do perfil
    document.getElementById("profile-name").textContent = user.name;
    document.getElementById("profile-email").textContent = user.email || "E-mail não cadastrado";
    document.getElementById("profile-bio").textContent = user.bio || "Nenhuma bio fornecida";
    document.getElementById("profile-course").textContent = user.course || user.identifier || "Curso não definido";

    // Imagens
    document.getElementById("profile-img").src = user.profilePicture || "img/placeholder-profile.jpg";
    document.getElementById("banner-img").src = user.banner || "img/placeholder-banner.jpg";

    // Preenche o formulário de edição
    if (document.getElementById("username")) {
      document.getElementById("username").value = user.name || "";
      document.getElementById("userhandle").value = user.email || "";
      document.getElementById("bio").value = user.bio || "";
      document.getElementById("course").value = user.course || user.identifier || "";
    }

    // Carrega os posts
    loadUserPosts();

  } catch (error) {
    console.error('Erro ao carregar página:', error);
    document.body.innerHTML = `
      <div style="text-align: center; padding: 50px;">
        <h2>Erro ao carregar a página</h2>
        <p>${error.message}</p>
        <button onclick="window.location.href='/login.html'" 
                style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px;">
          Fazer login
        </button>
      </div>
    `;
  }
});



// Debug: Verifica o conteúdo do localStorage
console.log('Conteúdo do localStorage:', localStorage.getItem('user'));

// Debug: Verifica se está logado
const user = JSON.parse(localStorage.getItem('user') || '{}');
console.log('Usuário logado:', user);
if (!user.id) {
  console.error('Usuário não tem ID:', user);
}
</script>




</body>

</html>


